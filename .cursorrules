# PROJECT RULESET — STABLE VERSION (UNIVERSAL)

## Tech Stack
- Laravel 10/11
- PHP 8.2+
- PostgreSQL
- Laravel Modules (nWidart)
- Spatie Permission
- Pest PHP (Testing Framework)
- Spatie Query Builder (Filtering/Sorting)
- Spatie Media Library (Media Management)

---

# Architectural Guidelines

## Modular Monolith
- Semua fitur baru HARUS di dalam `Modules/`
- Cross-module communication hanya via Public Service + Contract

## Service Pattern
- Business logic TIDAK boleh di Controller
- Satu Service = satu use-case (Command Style)
- Satu Service hanya punya 1 public method (`execute()`/`handle()`)
- Service menerima Array atau DTO (bukan Request)

## Repository Pattern
- Query kompleks + reusable → Repository
- Repository meng-extend `App\Repositories\BaseRepository`
- Service memanggil Repository, bukan Model langsung

## Dependency Injection
- Gunakan DI untuk Service, Repository, Event
- Minimalkan penggunaan Facade jika bisa DI

## Strict Types
- `declare(strict_types=1);` Wajib untuk semua file

---

# Domain Rules

## Single Responsibility
- Dilarang membuat God-Service/God-Class
- Pisahkan Command dan Query jika diperlukan (CQRS-lite)

## Boundaries
- Cross-module dilarang akses Model/DB module lain
- Hanya boleh via Contract Public Service

## Contracts (Interfaces)
- Public Service expose Contract
- Gunakan Provider untuk binding implementation
- **Interface Consistency Rule**: Implementation wajib cocok 1:1 dengan Interface.
- **Contract First**: Update interface dahulu baru implementasi.

---

# Event & Side Effects
- Core transaction di Service
- Side Effects (email, notif, webhook, audit, logging) via Event + Listener

---

# Database Transaction Rules
- Write operation multi-table wajib pakai DB Transaction
- Transaction berada di Service layer

---

# Security Rules
- $fillable wajib ketat (hindari mass assignment)
- Endpoint sensitif wajib rate limiting
- Audit dilakukan via Event/Listener

---

# Media Management (Spatie Media Library)
- Model yang memiliki media wajib implement `HasMedia` dan use `InteractsWithMedia`.
- Definisikan `registerMediaCollections()` untuk setiap model.
- Gunakan `singleFile()` untuk koleksi avatar atau gambar profil tunggal.
- Upload ditangani di Controller/Request, lalu path/file diteruskan ke Service.

---

# API Resource & Exposure Rules
- Response API wajib menggunakan `JsonResource`.
- Dilarang return Model langsung.
- Resource mengatur formatting, type casting, dan exposure control.
- **Translatable Keys**: Gunakan key translatable untuk pesan response (`messages.xxx`).

---

# Caching Rules
- Caching hanya boleh di Service/Repository
- Key format: `{module}:{entity}:{id}`
- Wajib memiliki invalidation

---

# Logging & Audit
- Aksi sensitif wajib audit
- Audit via Event, bukan inline logic

---

# API Versioning
- Semua route API menggunakan prefix versi (`api/v1`)
- Breaking change → versi baru (`v2`)

---

# Error Handling Strategy
- Domain error → Custom Exception
- Validation error → ValidationException
- Dilarang return array error manual
- Global handler memetakan error ke response standar

---

# Search / Filter / Sort / Pagination
- Gunakan `Spatie\QueryBuilder\QueryBuilder`.
- **Search**: Wajib menggunakan Meilisearch via Laravel Scout (`Model::search()`) untuk semua fitur pencarian teks. Gunakan parameter `search` secara langsung (top-level), bukan `filter[search]`.
- **No LIKE Queries**: Dilarang menggunakan `where('field', 'like', '%...%')` untuk fitur pencarian yang bersifat user-facing.
- Definisikan `allowedFilters`, `allowedSorts`, dan `defaultSort` secara eksplisit.
- Gunakan helper `paginateResponse()` dari `ApiResponse` trait untuk format pagination yang konsisten (`meta.pagination`).

---

# Modular Path Enforcement
- Controller: `Modules/{Module}/app/Http/Controllers`
- Request/DTO: `Modules/{Module}/app/Http/Requests`
- Service: `Modules/{Module}/app/Services`
- Repository: `Modules/{Module}/app/Repositories`
- Contract: `Modules/{Module}/app/Contracts`
- Query: `Modules/{Module}/app/Queries`
- Provider: `Modules/{Module}/app/Providers`

---

# Refactor & Safety Rules
- **Duplicate method forbidden**: Dilarang ada deklarasi method ganda dalam satu file.
- **Import Hygiene**: Unused import dilarang. Urutkan import secara logis (Laravel, Module, Vendor).
- **Namespace consistency**: Namespace wajib mengikuti struktur folder PSR-4.
- Cross-module direct Model access forbidden.

---

# Error Prevention
- **Type Hinting**: Wajib gunakan type hinting untuk semua parameter dan return type.
- **Null Safety**: Hindari `null` sebisa mungkin. Gunakan `Optional` atau `default values`.
- **Immutable Objects**: Gunakan DTO/Value Objects yang immutable untuk mencegah side effects yang tidak diinginkan.

---

# Testing Strategy (Universal)

## 1. Service Tests (Unit)
Wajib menguji:
- Positive & Negative case
- Business validation & Exception case
- Dependencies wajib MOCK

## 2. Repository Tests (Integration)
Wajib menguji:
- Filter, Sort, Search, Pagination
- Soft-delete & Eager loading

## 3. Controller Tests (Feature)
Wajib menguji:
- HTTP Response & JSON format
- Validation errors & Auth/Permission guard

## 4. Validation Tests
Wajib menguji:
- Required, Type, Format
- Boundary & Forbidden values
- Conflict domain values (ex: duplicate)

## 5. Custom Exception Tests
Minimal 1 case untuk mapping & throw

## 6. Coverage Expectation
- Service = 100% behavior coverage
- Repository = 100% query behavior coverage
- Controller = major flow coverage

## 7. CI Enforcement
- Merge ke `main/master` dilarang jika test gagal

---

# Communication Language
- Bahasa Indonesia untuk dokumentasi & komunikasi.
- English untuk istilah teknis tetap diperbolehkan.
